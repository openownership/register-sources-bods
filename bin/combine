#!/usr/bin/env bash
set -Eeuo pipefail

src_d=$1
dst_f=${2:-data/exports/$(date -Is).jsonl.gz}

rds_chunk_n=750
rds_ns=register-files-combiner
tmp=$(mktemp -d)
#-------------------------------------------------------------------------------
function _clean() {
    rm -rf "${tmp:?}"
}

function _redis() {
    redis-cli -u "$REDIS_URL" "$@"
}

function _log() {
    msg=$1
    sep=${2:-" "}
    printf "%7s$sep" "$msg"
}

trap _clean EXIT
#-------------------------------------------------------------------------------
echo -e "\n=== PING\n"

_redis PING
touch "$tmp/redis"
#-------------------------------------------------------------------------------
echo -e "\n=== LIST\n"

mapfile -d '' src_fs < <(find "$src_d" \
    \( -name '.*' -prune \) -o -type f -print0 | sort -z)
echo "files: ${#src_fs[@]}"
#-------------------------------------------------------------------------------
echo -e "\n=== INDEX\n"

for src_f in "${src_fs[@]}" ; do
    _log "$src_f"
    src_k=$rds_ns/src/$src_f
    src_n=$(_redis SCARD "$src_k")
    _log "$src_n"
    
    if [ "$src_n" -eq 0 ] ; then
        mapfile -t ids < <(jq -r '.statementID' < "$src_f" | sort -u)
        
        for ((i=0 ; i < ${#ids[@]}; i+=rds_chunk_n)) ; do
            chunk=( "${ids[@]:i:$rds_chunk_n}" )
            echo "SADD '$src_k' ${chunk[*]@Q}" >> "$tmp/redis"
        done
        
        src_n=${#ids[@]}
        st="*"
    else
        st="."
    fi
    
    _log "$src_n"
    _log "$st" "\n"
done
#-------------------------------------------------------------------------------
echo -e "\n=== LOAD\n"

# shellcheck disable=SC2012
dst_s=$(ls -lh "$tmp/redis" | awk '{ print $5 }')
echo -e "loading: $dst_s\n"
_redis --pipe < "$tmp/redis"
#-------------------------------------------------------------------------------
echo -e "\n=== COMBINE\n"

dst_k=$rds_ns/dst/$dst_f
tmp_k=$dst_k.tmp
touch "$dst_f"
_redis DEL "$tmp_k" >/dev/null

for src_f in "${src_fs[@]}" ; do
    _log "$src_f"
    src_k=$rds_ns/src/$src_f
    src_n=$(_redis SCARD "$src_k")
    _log "$src_n"
    diff_n=$(_redis SDIFFSTORE "$tmp_k" "$src_k" "$dst_k")
    _log "$diff_n"
    
    if [ "$diff_n" -gt 0 ] ; then
        _redis SMEMBERS "$tmp_k" | jq -R |
            sed 's/^/"statementID":/' > "$tmp/grep"
        uniq "$src_f" | jq -c '.' | grep -f "$tmp/grep" -F | gzip -c >> "$dst_f"
    fi
    
    dst_n=$(_redis SUNIONSTORE "$dst_k" "$dst_k" "$tmp_k")
    _log "$dst_n"
    # shellcheck disable=SC2012
    dst_s=$(ls -lh "$dst_f" | awk '{ print $5 }')
    _log "$dst_s"
    src_n=$(_redis SCARD "$src_k")
    _redis DEL "$tmp_k" >/dev/null
    
    if [ "$diff_n" -eq 0 ] ; then
        st='.'
    elif [ "$diff_n" -eq "$src_n" ] ; then
        st='*'
    else
        st='~'
    fi
    
    _log "$st" "\n"
done
#-------------------------------------------------------------------------------
echo -e "\n=== OUTPUT\n"

cat << EOF
source:      $src_d
destination: $dst_f
statements:  $dst_n
size:        $dst_s
duration:    ${SECONDS}s

EOF
