#!/usr/bin/env bash
set -Eeuo pipefail

src=$1

ns=register-files-combiner
tmp=$(mktemp -d)
tmp_redis=$tmp/batch.redis
#-------------------------------------------------------------------------------
function _clean() {
    rm -rf "${tmp:?}"
}

function _redis() {
    redis-cli -u "$REDIS_URL" "$@"
}

trap _clean EXIT
#-------------------------------------------------------------------------------
echo -e "\n=== PING\n"

_redis -c PING

touch "$tmp_redis"
#-------------------------------------------------------------------------------
echo -e "\n=== LIST\n"

mapfile -d '' src_fs < <(
    find "$src" \( -name '.*' -prune \) -o -type f -print0 | sort -z
)

echo "${#src_fs[@]} files"
#-------------------------------------------------------------------------------
echo -e "\n=== INDEX\n"

for src_f in "${src_fs[@]}" ; do
    src_k=$ns/src/$src_f
    rtn=$(_redis -c SCARD "$src_k")
    if [ "$rtn" -eq 0 ] ; then
        mapfile -t ids < <(
            jq -r '.statementID' < "$src_f"
        )
        echo "SADD '$src_k' ${ids[*]@Q}" >> "$tmp_redis"
        echo "* $src_f"
    else
        echo ". $src_f [$rtn]"
    fi
done
#-------------------------------------------------------------------------------
echo -e "\n=== LOAD\n"

_redis --pipe < "$tmp_redis"
#-------------------------------------------------------------------------------
echo
