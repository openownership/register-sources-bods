#!/usr/bin/env bash
set -Eeuo pipefail

src_d=$1
dst_f=${2:-data/exports/$(date -Is).jsonl.gz}

rds_chunk_n=750
rds_ns=register-files-combiner

tmp=$(mktemp -d)
#-------------------------------------------------------------------------------
function _clean() {
    rm -rf "${tmp:?}"
}

function _redis() {
    redis-cli -u "$REDIS_URL" "$@"
}

function _index_status() {
    if [ "$1" -eq 0 ] ; then
        echo '*'
    else
        echo '.'
    fi
}

function _combine_status() {
    if [ "$1" -eq 0 ] ; then
        echo '.'
    elif [ "$1" -eq "$2" ] ; then
        echo '>'
    else
        echo '+'
    fi
}

trap _clean EXIT
#-------------------------------------------------------------------------------
echo -e "\n=== PING\n"

_redis PING

touch "$tmp/redis"
#-------------------------------------------------------------------------------
echo -e "\n=== LIST\n"

mapfile -d '' src_fs < <(find "$src_d" \
    \( -name '.*' -prune \) -o -type f -print0 | sort -z)

echo "${#src_fs[@]} files"
#-------------------------------------------------------------------------------
echo -e "\n=== INDEX\n"

for src_f in "${src_fs[@]}" ; do
    src_k=$rds_ns/src/$src_f
    
    src_n=$(_redis SCARD "$src_k")
    
    if [ "$src_n" -eq 0 ] ; then
        mapfile -t ids < <(jq -r '.statementID' < "$src_f" | sort -u)
        
        src_n=${#ids[@]}
        
        for ((i=0 ; i < ${#ids[@]}; i+=rds_chunk_n)) ; do
            chunk=( "${ids[@]:i:$rds_chunk_n}" )
            echo "SADD '$src_k' ${chunk[*]@Q}" >> "$tmp/redis"
        done
    fi
    
    printf "%s %s %5s\n" "$(_index_status "$src_n")" "$src_f" "$src_n"
done
#-------------------------------------------------------------------------------
echo -e "\n=== LOAD\n"

ls -lh "$tmp/redis"
echo

_redis --pipe < "$tmp/redis"
#-------------------------------------------------------------------------------
echo -e "\n=== COMBINE\n"

dst_k=$rds_ns/dst/$dst_f
tmp_k=$dst_k.tmp

touch "$dst_f"

_redis DEL "$tmp_k" >/dev/null

for src_f in "${src_fs[@]}" ; do
    src_k=$rds_ns/src/$src_f
    
    diff_n=$(_redis SDIFFSTORE "$tmp_k" "$src_k" "$dst_k")
    
    _redis SMEMBERS "$tmp_k" | jq -R > "$tmp/jq"
    
    jq -c --slurpfile ids "$tmp/jq" \
        '. | select(.statementID | IN($ids[]))' \
        < "$src_f" | gzip -c >> "$dst_f"
    
    dst_n=$(_redis SUNIONSTORE "$dst_k" "$dst_k" "$tmp_k")
    
    # shellcheck disable=SC2012
    dst_s=$(ls -lh "$dst_f" | awk '{ print $5 }')
    
    src_n=$(_redis SCARD "$src_k")
    
    _redis DEL "$tmp_k" >/dev/null
    
    printf "%s %s %5s %5s %5s\n" "$(_combine_status "$diff_n" "$src_n")" \
        "$src_f" "$diff_n" "$dst_n" "$dst_s"
done
#-------------------------------------------------------------------------------
echo -e "\n=== OUTPUT\n"

ls -lh "$dst_f"
#-------------------------------------------------------------------------------
echo
