#!/usr/bin/env bash
set -Eeuo pipefail

date=$(date -Is)
dst_ext=.jsonl.gz
log_ext=.log

src_d=$1
dst_d=${2:-data/exports}
dst_f=$dst_d/${3:-$date}$dst_ext

src_d=$(realpath -s --relative-base . "$src_d")
dst_f=$(realpath -s --relative-base . "$dst_f")
log_f=$(dirname "$dst_f")/$(basename "$dst_f" "$dst_ext").$date$log_ext
snp_f=$(dirname "$dst_f")/$(basename "$dst_f" "$dst_ext").$date$dst_ext
idx_d=$dst_d/indexes
#-------------------------------------------------------------------------------
function _clean() {
    rm -rf "${tmp:?}"
}

function _echo() {
    local msg=${1:-}
    echo -e "$msg" | tee -a "$log_f"
}

function _log() {
    local msg=$1
    local sep=${2:-" "}
    printf "%9s$sep" "$msg" | tee -a "$log_f"
}

function _idx() {
    echo "$idx_d/$1.idx"
}

function _idxn() {
    echo "$idx_d/$1.idxn"
}

function _idxf() {
    echo "$idx_d/$1.idxf"
}

function _index_size() {
    local f=$1
    if [ -f "$(_idxn "$f")" ] ; then
        cat "$(_idxn "$f")"
    else
        echo 0
    fi
}

function _index_create() {
    local f=$1
    mkdir -p "$(dirname "$(_idx "$f")")"
    if [ ! -f "$f" ] ; then
        touch "$(_idx "$f")"
    elif [ "$(file -b --mime-type "$f")" == 'application/gzip' ] ; then
        zcat "$f" | jq -r '.statementID' | sort -u > "$(_idx "$f")"
    else
        # shellcheck disable=SC2094
        jq -r '.statementID' < "$f" | sort -u > "$(_idx "$f")"
    fi
    wc -l < "$(_idx "$f")" > "$(_idxn "$f")"
}

function _index_diff() {
    local src=$1
    local dst=$2
    local buf=$3
    if test -f "$(_idxf "$dst")" && \
            grep -q -F "$src" "$(_idxf "$dst")" ; then
        echo 0
    else
        comm -23 "$(_idx "$src")" "$(_idx "$dst")" > "$buf"
        wc -l < "$buf"
    fi
}

function _index_insert() {
    local src=$1
    local dst=$2
    local buf=$3
    if [ -s "$buf" ] ; then
        cat "$(_idx "$dst")" "$buf" | sort -u > "$tmp/idx"
        mv "$tmp/idx" "$(_idx "$dst")"
        wc -l < "$(_idx "$dst")" > "$(_idxn "$dst")"
    fi
    echo "$src" >> "$(_idxf "$dst")"
}

trap _clean EXIT
tmp=$(mktemp -d)
#-------------------------------------------------------------------------------
echo
_echo "$date"
#-------------------------------------------------------------------------------
_echo "\n=== LIST\n"

mapfile -d '' src_fs < <(find "$src_d" \
    \( -name '.*' -prune \) -o -type f -print0 | sort -z)
_echo "files: ${#src_fs[@]}"
#-------------------------------------------------------------------------------
_echo "\n=== INDEX\n"

for f in "${src_fs[@]}" "$dst_f" ; do
    _log "$f"
    n=$(_index_size "$f")
    _log "$n"
    if [ "$n" -eq 0 ] ; then
        _index_create "$f"
        st='*'
    else
        st='.'
    fi
    n=$(_index_size "$f")
    _log "$n"
    _log "$st" "\n"
done
#-------------------------------------------------------------------------------
_echo "\n=== COMBINE\n"

for src_f in "${src_fs[@]}" ; do
    _log "$src_f"
    src_n=$(_index_size "$src_f")
    _log "$src_n"
    diff_n=$(_index_diff "$src_f" "$dst_f" "$tmp/diff")
    _log "$diff_n"
    if [ "$diff_n" -gt 0 ] ; then
        jq -R '.' "$tmp/diff" | sed 's/^/"statementID":/' > "$tmp/grep"
        jq -cS '.' "$src_f" | grep -F -f "$tmp/grep" | awk '!x[$0]++' |
            gzip -c >> "$dst_f"
    fi
    _index_insert "$src_f" "$dst_f" "$tmp/diff"
    dst_n=$(_index_size "$dst_f")
    _log "$dst_n"
    # shellcheck disable=SC2012
    dst_s=$(ls -lh "$dst_f" | awk '{ print $5 }')
    _log "$dst_s"
    if [ "$diff_n" -eq 0 ] ; then
        st='.'
    elif [ "$diff_n" -eq "$src_n" ] ; then
        st='*'
    else
        st='~'
    fi
    _log "$st" "\n"
done
#-------------------------------------------------------------------------------
_echo "\n=== SNAPSHOT\n"

cp "$dst_f" "$snp_f"
#-------------------------------------------------------------------------------
_echo "\n=== OUTPUT\n"

_echo "source:      $src_d"
_echo "destination: $dst_f"
_echo "snapshot:    $snp_f"
_echo "values:      $dst_n"
_echo "size:        $dst_s"
_echo "log:         $log_f"
_echo "duration:    ${SECONDS}s"
echo
