#!/usr/bin/env bash
set -Eeuo pipefail

src=$1
dst_f_=data/exports/$(date -Is).jsonl.gz
dst_f=${2:-$dst_f_}

ns=register-files-combiner
tmp=$(mktemp -d)
tmp_redis=$tmp/batch.redis
#-------------------------------------------------------------------------------
function _clean() {
    rm -rf "${tmp:?}"
}

function _redis() {
    redis-cli -u "$REDIS_URL" "$@"
}

trap _clean EXIT
#-------------------------------------------------------------------------------
echo -e "\n=== PING\n"

_redis -c PING

touch "$tmp_redis"
#-------------------------------------------------------------------------------
echo -e "\n=== LIST\n"

mapfile -d '' src_fs < <(
    find "$src" \( -name '.*' -prune \) -o -type f -print0 | sort -z
)

echo "${#src_fs[@]} files"
#-------------------------------------------------------------------------------
echo -e "\n=== INDEX\n"

for src_f in "${src_fs[@]}" ; do
    src_k=$ns/src/$src_f
    src_k_n=$(_redis -c SCARD "$src_k")
    if [ "$src_k_n" -eq 0 ] ; then
        mapfile -t ids < <(
            jq -r '.statementID' < "$src_f"
        )
        echo "SADD '$src_k' ${ids[*]@Q}" >> "$tmp_redis"
        state='*'
        src_k_n=${#ids[@]}
    else
        state='.'
    fi
    echo "$state $src_f [$src_k_n]"
done
#-------------------------------------------------------------------------------
echo -e "\n=== LOAD\n"

_redis --pipe < "$tmp_redis"
#-------------------------------------------------------------------------------
echo -e "\n=== COMBINE\n"

dst_k=$ns/dst/$dst_f
tmp_k=$dst_k.tmp

touch "$dst_f"
_redis -c DEL "$tmp_k" >/dev/null

for src_f in "${src_fs[@]}" ; do
    src_k=$ns/src/$src_f
    src_k_n=$(_redis -c SCARD "$src_k")
    dst_k_d=$(_redis -c SDIFFSTORE "$tmp_k" "$src_k" "$dst_k")
    ids_s=$(_redis --csv -c SMEMBERS "$tmp_k")
    if [ -n "$ids_s" ] ; then
        jq -c ". | select(.statementID | IN($ids_s))" < "$src_f" | gzip -c >> "$dst_f"
    fi
    dst_k_n=$(_redis -c SUNIONSTORE "$dst_k" "$dst_k" "$tmp_k")
    if [ "$dst_k_d" -eq 0 ] ; then
        state='.'
    elif [ "$dst_k_d" -eq "$src_k_n" ] ; then
        state='>'
    else
        state='+'
    fi
    echo "$state $src_f [$dst_k_d] [$dst_k_n]"
    _redis -c DEL "$tmp_k" >/dev/null
done
#-------------------------------------------------------------------------------
echo -e "\n=== OUTPUT\n"

ls -lh "$dst_f"
#-------------------------------------------------------------------------------
echo
